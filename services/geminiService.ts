import { GoogleGenAI } from "@google/genai";
import { Scores } from '../types';

if (!process.env.API_KEY) {
  throw new Error("API_KEY environment variable not set");
}

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

function formatPrompt(scores: Scores): string {
  const { A, B, C, D } = scores;

  return `
אתה יועץ ארגוני ופסיכולוג התנהגותי ברמה עולמית, המתמחה בניתוח אישיות אינטגרטיבי על פי מודל סגנונות התקשורת של יונג. המשימה שלך היא לספק ניתוח אישיות הוליסטי, מעמיק ומובנה למשתמש שהשלים שאלון.

**הנחיית ליבה: כתוב ניתוח אישי, מקצועי ומעצים, לא דוח טכני.**
*   **אל תשתמש באותיות (A, B, C, D) או במונחים טכניים מהמודל.**
*   **אל תסביר למשתמש *איך* הגעת למסקנות** (למשל, "בגלל שהציון שלך ב-X גבוה...").
*   התמקד בתיאור האדם השלם שנוצר מהשילוב הייחודי של תכונותיו.

**מידע רקע עבורך (לא להציג למשתמש):**
הניתוח מבוסס על הציונים הבאים, המשקפים שני צירים: מוחצנות (A) מול מופנמות (B), והתמקדות במשימה (C) מול התמקדות באנשים (D).
-   ציון A (מוחצנות): ${A}
-   ציון B (מופנמות): ${B}
-   ציון C (משימתיות): ${C}
-   ציון D (אנשים): ${D}
השילובים יוצרים 4 סגנונות עיקריים:
-   **אדום (A+C):** המשימתי/הביצועיסט. ישיר, החלטי, מכוון תוצאות.
-   **צהוב (A+D):** היוזם/המשפיע. חברותי, אופטימי, יצירתי.
-   **ירוק (B+D):** התומך/המגשר. סבלני, קשוב, איש צוות.
-   **כחול (B+C):** המנתח/הדייקן. זהיר, שיטתי, מאורגן.

**מבנה הניתוח המבוקש (בעברית, בפורמט Markdown):**

התחל את הניתוח ישירות עם פסקת הפתיחה הראשונה. אל תוסיף כותרת ראשית, היא כבר קיימת באפליקציה.

השתמש בכותרות הבאות בדיוק כפי שהן כתובות, עטופות בשתי כוכביות (לדוגמה: **כותרת**). כל כותרת צריכה להיות בשורה נפרדת.

**הסגנון הכללי שלך**
תאר בפסקה אחת את סגנון התקשורת והניהול הכללי של המשתמש, בהתבסס על שילוב הציונים. זוהי תמצית הפרופיל שלו.

**נקודות החוזק המרכזיות שלך**
בפסקה רציפה, תאר את החוזקות העיקריות הנובעות מהפרופיל. התמקד בתכונות החיוביות הבולטות ביותר וכיצד הן באות לידי ביטוי בסביבת עבודה ובתקשורת בינאישית.

**אתגרים פוטנציאליים ונקודות לצמיחה**
בפסקה נפרדת, תאר את ה"חולשות" או האתגרים האפשריים. הצג אותם כצד השני של החוזקות, או כנטיות טבעיות שיש להיות מודעים אליהן. השתמש בגישה בונה ומעצימה.

**הצעות מעשיות להתפתחות**
ספק בפסקה מספר הצעות קונקרטיות ופרקטיות לשיפור. ההצעות צריכות להיות מותאמות ישירות לפרופיל האישי, ולעזור למשתמש למנף את חוזקותיו ולהתמודד עם אתגריו.

**הפרופיל שלך באינטראקציה עם אחרים**
הוסף פסקה המתארת כיצד סגנון התקשורת של המשתמש עשוי להיתפס על ידי אנשים עם סגנונות אחרים (למשל, כיצד 'משימתי' נתפס על ידי 'תומך'), וכיצד הוא יכול לגשר על פערים אלו.

**סיכום ומחשבה קדימה**
פסקה קצרה המסכמת את הפוטנציאל הייחודי של המשתמש ומעודדת אותו להשתמש במודעות זו לצמיחה אישית ומקצועית.

ודא שהטון אישי, מקצועי, ומעניק תחושה של הבנה הוליסטית ולא של פירוק לגורמים.
`;
}

function formatScenarioPrompt(scores: Scores, scenario: string): string {
    const { A, B, C, D } = scores;

    return `
    אתה מאמן אישי (קואצ'ר) למנהלים, המתמחה ביישום מודל סגנונות התקשורת של יונג. המשימה שלך היא לספק ייעוץ מעשי, קצר וקולע למנהל שפרופיל האישיות שלו ידוע לך, לגבי סיטואציה ספציפית.

    **פרופיל המנהל (נתונים פנימיים עבורך):**
    - ציון A (מוחצנות): ${A}
    - ציון B (מופנמות): ${B}
    - ציון C (משימתיות): ${C}
    - ציון D (אנשים): ${D}

    **הסיטואציה:**
    "${scenario}"

    **המשימה שלך:**
    כתוב 2-3 פסקאות קצרות המעניקות למנהל **3 טיפים קונקרטיים ויישומיים** כיצד להתמודד עם הסיטואציה בהתחשב בסגנון התקשורת הדומיננטי שלו.
    
    **כללים חשובים:**
    1.  **התאמה אישית:** הטיפים חייבים להיות מותאמים באופן ישיר לפרופיל של המנהל. לדוגמה, למנהל "אדום" (A+C) תציע דרכים לרכך את הישירות שלו, ולמנהל "ירוק" (B+D) תציע דרכים להיות יותר אסרטיבי.
    2.  **מעשיות:** ספק עצות פרקטיות, לא תיאוריות. מה בדיוק עליו לעשות או לומר.
    3.  **טון:** השתמש בטון ישיר, מעצים וממוקד פתרון.
    4.  **פורמט:** השתמש בפורמט Markdown. הצג את הטיפים כרשימה ממוספרת. התחל ישירות עם התשובה, ללא פתיחים מיותרים.
    `;
}


const callGemini = async (prompt: string): Promise<string> => {
     try {
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
        });
        
        return response.text;
    } catch (error) {
        console.error("Error calling Gemini API:", error);
        throw new Error("Failed to generate analysis from Gemini API.");
    }
}

export const generateQuizAnalysis = async (scores: Scores): Promise<string> => {
  const prompt = formatPrompt(scores);
  return callGemini(prompt);
};

export const generateScenarioAnalysis = async (scores: Scores, scenario: string): Promise<string> => {
    const prompt = formatScenarioPrompt(scores, scenario);
    return callGemini(prompt);
};
